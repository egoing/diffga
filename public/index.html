<!doctype html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase-firestore.js"></script>
    <script>

        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDh-mw_xtDY7I5qAAKlSIKh5Ff5cx6xA_E",
            authDomain: "code-diff.firebaseapp.com",
            databaseURL: "https://code-diff.firebaseio.com",
            projectId: "code-diff",
            storageBucket: "",
            messagingSenderId: "768568314264"
        };
        firebase.initializeApp(config);
    </script>
    <script src="monaco-editor/min/vs/loader.js"></script>
    <style>
        *{
            box-sizing:border-box;
        }
        body {
            padding: 0;
            margin: 0;
            height: 100vh;
            /*display:grid;*/
            /*grid-template-rows: 2rem 1fr;*/
        }

        #editorWrap{
            display:grid;
            grid-template-rows: 2fr 1fr;
            height:100%;
        }

        #container{
            display:grid;
            grid-template-columns: 1fr 1fr;
        }

        #student{
            border-right:1px solid #565658;
        }

        #diff{
            border-top:1px solid #565658;
        }

        #languages{
            font-size:1rem;
            position:absolute;
            z-index: 10000;
            right:0.5rem;
            bottom:0.5rem;

        }
    </style>
</head>
<body>
<!--<div id="ui">-->
    <select name="" id="languages">

    </select>
<!--</div>-->
<div id="editorWrap">
    <div id="container">
        <div id="student" class="editor"></div>
        <div id="teacher" class="editor"></div>
    </div>
    <div id="diff"></div>
</div>
<script>
    var db = firebase.firestore();
    var classes = db.collection("classes");
</script>
<script>
    require.config({paths: {'vs': 'monaco-editor/min/vs'}});

    function updateFirestore() {
        db.collection("classes").doc(window.location.hash).set({
            code: teacherEditor.getValue(),
            updated: firebase.firestore.FieldValue.serverTimestamp(),
            language: ($('#languages').find('option:selected').text())
        });
    }

    require(['vs/editor/editor.main'], function () {

        var diffEditor = monaco.editor.createDiffEditor(document.getElementById("diff"),
            {originalEditable: true, renderSideBySide: false}
        );

        studentModel = monaco.editor.createModel('', "text/html");
        teacherModel = monaco.editor.createModel("", "text/html");

        diffEditor.setModel({
            original: studentModel,
            modified: teacherModel
        });


        studentEditor = monaco.editor.create(document.getElementById('student'), {
            value: '',
            language: 'javascript',
            theme: 'vs-dark'
        });

        studentEditor.onKeyUp(function(e){
            /*studentModel.setValue(studentModel.getValue());
            diffEditor.setModel({
                original: studentModel,
                modified: teacherModel
            });*/
            studentModel.setValue(studentEditor.getValue());
        })

        teacherEditor = monaco.editor.create(document.getElementById('teacher'), {
            value: '',
            language: 'javascript',
            theme: 'vs-dark'
        });

        setInterval(function(){
            if(window.prev !== teacherEditor.getValue()){
                if(teacherEditor.isFocused()){
                    console.log('update');
                    updateFirestore();
                }
                teacherModel.setValue(teacherEditor.getValue());
            }
            prev = teacherEditor.getValue();
        }, 1000);


        classes.doc(window.location.hash).onSnapshot(function (doc) {
            var newVal = doc && doc.data().code;
            if(newVal !== teacherEditor.getValue()){
                console.log('->',newVal, '->',teacherEditor.getValue());
                teacherEditor.setValue(newVal);
            }
        });

        var supportedLangs = monaco.languages.getLanguages();
        for(var i=0; i<supportedLangs.length; i++){
            $('#languages').append('<option value="'+supportedLangs[i].id+'">'+supportedLangs[i].id+'</option>')
        }
        $('#languages').change(function(e){
            var selected = ($(this).find('option:selected').text());
            monaco.editor.setModelLanguage(studentEditor.getModel(), selected);
            monaco.editor.setModelLanguage(teacherEditor.getModel(), selected);
            updateFirestore();
        })
    });

</script>
</body>
</html>